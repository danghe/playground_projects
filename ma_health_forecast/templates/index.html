<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M&A Health Forecast</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body>
    <!-- Executive Navbar -->
    <!-- Shared Executive Header -->
    {% with active_page='macro' %}
    {% include 'header_partial.html' %}
    {% endwith %}

    <div class="container-fluid py-4 px-4">
        <div class="row">
            <!-- Sidebar Controls -->
            <div class="col-lg-3 mb-4">
                <!-- Metrics Card -->
                <div class="card mb-3">
                    <div class="card-body p-4">
                        <div class="row text-center">
                            <div class="col-6 border-end">
                                <div class="metric-label mb-2">Current Index</div>
                                <div class="metric-value" id="latest-val">{{ "%.1f"|format(latest_val) }}</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-label mb-2">12M Forecast</div>
                                <div class="metric-value text-success" id="fc-val">{{ "%.1f"|format(fc_val) }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Simulator Card -->
                <div class="card">
                    <div class="card-header bg-light">
                        <i class="bi bi-sliders"></i> Market Simulator
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-4">Adjust macroeconomic drivers to simulate future scenarios.</p>
                        <form id="simulation-form">
                            <div class="mb-4">
                                <label class="form-label fw-bold small text-uppercase text-secondary">Interest Rates
                                    (bps)</label>
                                <input type="range" class="form-range" id="rate_change" min="-100" max="100" step="25"
                                    value="0" oninput="updateOutput('rate_val', this.value)">
                                <div class="d-flex justify-content-between small text-muted font-monospace">
                                    <span>-100</span>
                                    <span id="rate_val" class="fw-bold text-dark">0</span>
                                    <span>+100</span>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold small text-uppercase text-secondary">CEO
                                    Confidence</label>
                                <input type="range" class="form-range" id="confidence_shock" min="-20" max="20" step="5"
                                    value="0" oninput="updateOutput('conf_val', this.value)">
                                <div class="d-flex justify-content-between small text-muted font-monospace">
                                    <span>Bear</span>
                                    <span id="conf_val" class="fw-bold text-dark">0</span>
                                    <span>Bull</span>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold small text-uppercase text-secondary">Market
                                    Volatility</label>
                                <input type="range" class="form-range" id="volatility_shock" min="-10" max="10" step="1"
                                    value="0" oninput="updateOutput('vol_val', this.value)">
                                <div class="d-flex justify-content-between small text-muted font-monospace">
                                    <span>Low</span>
                                    <span id="vol_val" class="fw-bold text-dark">0</span>
                                    <span>High</span>
                                </div>
                            </div>

                            <hr class="my-3 opacity-25">

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="include-ai-forecast">
                                <label class="form-check-label small fw-bold" for="include-ai-forecast">
                                    Generate AI Narrative
                                </label>
                                <div class="text-muted small" style="font-size: 0.75rem;">Uses Gemini to explain the
                                    forecast.</div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 py-2 shadow-sm" id="run-btn">RUN
                                SIMULATION</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-lg-9">
                <!-- 1. Executive Summary (Top) -->
                <div class="card mb-4" id="narrative-card" style="border-left: 4px solid var(--il-gold);">
                    <div
                        class="card-header d-flex justify-content-between align-items-center bg-white border-bottom-0 pt-3 pb-0">
                        <span>EXECUTIVE SUMMARY</span>
                        <span class="badge badge-warning-soft text-uppercase" style="font-size: 0.7rem;">Gemini
                            Analysis</span>
                    </div>
                    <div class="card-body position-relative pt-2">
                        <div id="narrative-loader" class="d-none">
                            <div class="shimmer w-100 mb-2" style="height: 16px; border-radius: 4px;"></div>
                            <div class="shimmer w-100 mb-2" style="height: 16px; border-radius: 4px;"></div>
                            <div class="shimmer w-75" style="height: 16px; border-radius: 4px;"></div>
                        </div>
                        <div id="narrative-content" class="fs-6 text-secondary">
                            <p class="text-muted">Loading summary...</p>
                        </div>
                    </div>
                </div>

                <!-- 2. Main Forecast Chart (Full Width) -->
                <div class="card mb-4 position-relative" id="main-chart-card">
                    <div class="spinner-overlay">
                        <div class="spinner-border text-primary"></div>
                    </div>
                    <div class="card-header d-flex justify-content-between">
                        <span>FORECAST OUTLOOK (12-MONTH HORIZON)</span>
                        <small class="text-muted">VAR Model + AI Overlay</small>
                    </div>
                    <div class="card-body text-center p-0" style="background-color: #fdfdfd;">
                        <img id="plot_url" src="data:image/png;base64,{{ plot_url }}" class="img-fluid"
                            alt="Forecast Chart"
                            style="max-height: 450px; width: auto; max-width: 100%; border-radius: 0 0 8px 8px;">
                    </div>
                    <div class="card-footer bg-white border-0 pt-0">
                        <p id="desc_plot_url" class="text-muted small mb-0 mt-2 fst-italic">{{ descriptions['plot_url']
                            }}</p>
                    </div>
                </div>

                <!-- 3. Key Drivers (Side-by-Side) -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100 position-relative" id="attribution-card">
                            <div class="spinner-overlay">
                                <div class="spinner-border text-primary"></div>
                            </div>
                            <div class="card-header">Current Drivers (Attribution)</div>
                            <div class="card-body text-center p-2">
                                <img id="attribution_url" src="data:image/png;base64,{{ attribution_url }}"
                                    class="img-fluid rounded" alt="Attribution">
                                <p id="desc_attribution_url" class="text-muted small mt-2">{{
                                    descriptions['attribution_url'] }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 position-relative" id="irf-card">
                            <div class="spinner-overlay">
                                <div class="spinner-border text-primary"></div>
                            </div>
                            <div class="card-header">Shock Impact (Impulse Response)</div>
                            <div class="card-body text-center p-2">
                                <img id="irf_url" src="data:image/png;base64,{{ irf_url }}" class="img-fluid rounded"
                                    alt="IRF">
                                <p id="desc_irf_url" class="text-muted small mt-2">{{ descriptions['irf_url'] }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. Secondary Data (Collapsible/Row 2) -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card h-100 position-relative">
                            <div class="spinner-overlay">
                                <div class="spinner-border text-primary"></div>
                            </div>
                            <div class="card-header">Historical Trend</div>
                            <div class="card-body text-center p-2">
                                <img id="history_url" src="data:image/png;base64,{{ history_url }}"
                                    class="img-fluid rounded">
                                <p id="desc_history_url" class="text-muted small mt-2 d-none">{{
                                    descriptions['history_url'] }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 position-relative">
                            <div class="spinner-overlay">
                                <div class="spinner-border text-primary"></div>
                            </div>
                            <div class="card-header">Component Evolution</div>
                            <div class="card-body text-center p-2">
                                <img id="contributions_url" src="data:image/png;base64,{{ contributions_url }}"
                                    class="img-fluid rounded">
                                <p id="desc_contributions_url" class="text-muted small mt-2 d-none">{{
                                    descriptions['contributions_url'] }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. Tertiary Data (Deal Activity & Confidence) -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card h-100 position-relative" id="deal-activity-card">
                            <div class="spinner-overlay">
                                <div class="spinner-border text-primary"></div>
                            </div>
                            <div class="card-header">Deal Activity Proxy (C&I Loans)</div>
                            <div class="card-body text-center p-2">
                                <img id="deal_activity_url" src="data:image/png;base64,{{ deal_activity_url }}"
                                    class="img-fluid rounded" alt="Deal Activity">
                                <p id="desc_deal_activity_url" class="text-muted small mt-2">{{
                                    descriptions['deal_activity_url'] }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 position-relative" id="confidence-card">
                            <div class="spinner-overlay">
                                <div class="spinner-border text-primary"></div>
                            </div>
                            <div class="card-header">CEO Confidence (OECD)</div>
                            <div class="card-body text-center p-2">
                                <img id="confidence_url" src="data:image/png;base64,{{ confidence_url }}"
                                    class="img-fluid rounded" alt="CEO Confidence">
                                <p id="desc_confidence_url" class="text-muted small mt-2">{{
                                    descriptions['confidence_url'] }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function updateOutput(id, val) {
            document.getElementById(id).innerText = val;
        }

        async function fetchNarrative(params) {
            const narrativeContent = document.getElementById('narrative-content');
            const narrativeLoader = document.getElementById('narrative-loader');
            narrativeContent.classList.add('d-none');
            narrativeLoader.classList.remove('d-none');

            try {
                const response = await fetch('/api/narrative', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                const data = await response.json();
                narrativeContent.innerHTML = data.html;
            } catch (error) {
                narrativeContent.innerHTML = `<p class="text-danger small">System Alert: Failed to retrieve narrative intelligence.</p>`;
            } finally {
                narrativeLoader.classList.add('d-none');
                narrativeContent.classList.remove('d-none');
            }
        }

        async function updateDashboard(e) {
            e.preventDefault();
            const btn = document.getElementById('run-btn');
            const originalText = btn.innerText;
            const includeAI = document.getElementById('include-ai-forecast').checked;

            btn.disabled = true;
            btn.innerText = includeAI ? "ANALYZING..." : "CALCULATING...";
            document.querySelectorAll('.card').forEach(c => c.classList.add('loading'));

            const params = {
                rate_change: document.getElementById('rate_change').value,
                confidence_shock: document.getElementById('confidence_shock').value,
                volatility_shock: document.getElementById('volatility_shock').value,
                include_ai: includeAI
            };

            try {
                const chartRes = await fetch('/api/update_forecast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                const chartData = await chartRes.json();

                for (const [key, val] of Object.entries(chartData.plots)) {
                    const img = document.getElementById(key);
                    if (img) img.src = `data:image/png;base64,${val}`;
                }

                // Update descriptions if present
                if (chartData.descriptions) {
                    for (const [key, val] of Object.entries(chartData.descriptions)) {
                        const desc = document.getElementById(`desc_${key}`);
                        if (desc) desc.innerText = val;
                    }
                }

                document.getElementById('latest-val').innerText = parseFloat(chartData.latest_val).toFixed(1);
                document.getElementById('fc-val').innerText = parseFloat(chartData.fc_val).toFixed(1);

                await fetchNarrative(params);

            } catch (error) {
                console.error(error);
                alert("Simulation failed. Check system logs.");
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
                document.querySelectorAll('.card').forEach(c => c.classList.remove('loading'));
            }
        }

        document.getElementById('simulation-form').addEventListener('submit', updateDashboard);

        document.addEventListener('DOMContentLoaded', () => {
            // Initial load
            fetchNarrative({ rate_change: 0, confidence_shock: 0, volatility_shock: 0, include_ai: false });
        });
    </script>
</body>

</html>